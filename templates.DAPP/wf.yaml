{# Шаблон для формирования yaml-файла описания рабочего потока #}
name: {{ ctx.flow_name }}
type: WORK_FLOW
schema_version: '1.16'
version: 1
tags:
    {%- for tag in ctx.tags %}
  - {{tag}}
    {%- endfor %}

orientation: TB

transaction:
  operator_default_timeout: 1800
  resources_lock_attempt_timeout: 60
  resources_lock_attempts: 30

sources:
{%- for source in ctx.sources %}
  - short_name: {{ source.short_name }}
    resource_cd: {{ source.system }}.{{ source.schema }}.{{ source.table }}
    type: DB_TABLE
    object: {{source.table}}
{%- endfor %}

targets:
{%- for target in ctx.targets %}
  - short_name: {{target.short_name}}
    resource_cd: {{target.resource_cd}}
    schema: {{target.schema}}
    table: {{target.table}}

  {% for hub in target.hubs %}
  - short_name: {{ hub.short_name }}
    schema: {{ hub.schema }}
    table: {{ hub.table }}
    resource_cd: ceh.{{ hub.resource_cd }}
  {% endfor %}
{%- endfor %}

local_metrics:
{% for local_metric in ctx.local_metrics %}
  wf_dataset_max_date_to:
    target: stage_T_input
    query: max(date_trunc('{{ local_metric.processed_dt_conversion }}', {{ local_metric.processed_dt }}))
    on_null: .conf.algos."{{ local_metric.algo }}".by_src."{{ local_metric.system }}.{{ local_metric.schema }}.{{ local_metric.name }}".wf_dataset_max_date_to
{%- endfor %}

mappings:
  marts:
  {% for mart in ctx.marts %}
    - short_name: {{mart.short_name}}
      algorithm_uid: {{ mart.algorithm_uid }}
      algorithm_uid_2: {{ mart.algorithm_uid_2 }}
      target: {{mart.target}}
      source: {{mart.source}}
      delta_mode: {{ mart.delta_mode }}

      where_clause:
        engine: jq
        template: {{ mart.processed_dt }} >= '{from}' and {{ mart.processed_dt }} < '{to}'
        vars:
          from: |
            .conf.algos."{{ mart.algo }}".by_src."{{ mart.source_system }}.{{ mart.source_schema }}.{{ mart.source_name }}".wf_dataset_max_date_to
          to:   |
            .conf.algos."{{ mart.algo }}".by_src."{{ mart.source_system }}.{{ mart.source_schema }}.{{ mart.source_name }}".{{mart.actual_dttm_name}} | strptime("%Y-%m-%dT%H:%M:%S") | mktime + 1 | strftime("%Y-%m-%dT%H:%M:%S")

      metrics:
        by_src:
          - save_as: wf_dataset_max_date_to
            metric:  wf_dataset_max_date_to

      field_map:
      {% for field in mart.fields_map %}
        {{ field.tgt_field }}:
          type: {{field.value_type}}
          value: {{ field.value }}
          field_type: {{ field.tgt_field_type }}
      {% endfor %}
      ref_map: []

      {%- if mart.mart_hub_list|length > 0 %}
      hub_map:
        {% for hub in mart.mart_hub_list %}
        - rk_field: {{ hub.rk_field }} 
          target: {{ hub.hub_target }}
          business_key_schema: {{ hub.business_key_schema }}
          on_full_null: {{ hub.on_full_null }}
          field_map:
            {{ hub.field }}:
            {%- if hub.src_type == "string" %}
              type: sql_expression
              value: | 
                case 
                  when {{ hub.value }} = '' then null
                  else {{ hub.value }}
                end
              field_type: TEXT
            {%- else %}
              {% if hub.value -%}
              type: column
              value: {{ hub.value }}
              field_type: {{hub.field_type}}
              {% else -%}
              type: sql_expression
              value: {{ hub.expression }}
              {% endif -%}
            {% endif -%}

        {% endfor %}
      {%- else %}
      hub_map: []
      {%- endif %}
  {% endfor %}